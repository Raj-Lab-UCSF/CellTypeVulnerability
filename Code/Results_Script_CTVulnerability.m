%% 1. Load data and filter out non-P301S datasets
clear; clc; rng(0);
matdir = '/Users/justintorok/Documents/MATLAB/CellTypeVulnerability_Project/CellTypeVulnerability/MatFiles';
addpath('/Users/justintorok/Documents/MATLAB/CellTypeVulnerability_Project/CellTypeVulnerability/Code/violin');
datapath = '/Users/justintorok/Documents/MATLAB/CellTypeVulnerability_Project/Large_MatFiles';
figdirectory = '/Users/justintorok/Documents/MATLAB/CellTypeVulnerability_Project/Figures/DraftFigs';
load([matdir filesep 'Mouse_Tauopathy_Data_HigherQ.mat'],'mousedata_struct');
datsetnames = fieldnames(mousedata_struct);

%% 2. Univariate analysis, cell-type-based vulnerability
%% 2.1 Correlation box plots, cell types, end timepoint
ctdataset = 'Yao';
load([datapath filesep 'Yao_Dependencies.mat']);
subclasses = classkey;
plotting = 1;
savenclose = 0;
corrtype = 'Pearson';
ctmat = outstruct.Bmeans;
t = 'end';
seedcorr = 1;
cmap = [[0 0.75 1]; [1 0 0.5]];
figtype = 'Yao';

[corrmat_t,logpmat_t] = CorrelationCalculator_singletimepoint(datsetnames,t,...
    mousedata_struct,ctmat,corrtype,seedcorr,matdir);
if plotting
    CorrelationBarPlot(corrmat_t,datsetnames,subclasses,corrtype,...
        cmap,figtype,savenclose,figdirectory);
    PValuePlot(logpmat_t,datsetnames,subclasses,corrtype,...
        copper(1000),cmap,savenclose,figdirectory);
    [classes,classmeans,pvals1,pvals2] = ClassViolinPlot(corrmat_t,subclasses,corrtype,...
        cmap,savenclose,figdirectory);
end

%% 2.2 Top 2 Cell Types, Brainframe 
% Requires the Brainframe repo: https://github.com/Raj-Lab-UCSF/Brainframe
brainframedir = '/Users/justintorok/Documents/MATLAB/Brainframe-Dev/Brainframe';
addpath(brainframedir)
corrmat_end_mean = mean(corrmat_t);
[~,maxind] = max(corrmat_end_mean);
[~,minind] = min(corrmat_end_mean);
toptypeinds = [maxind,minind];

plotting = 1;
savenclose = 0;
if length(subclasses) == 42 % Yao
    if plotting
        % Define colormap based on cell class
        nonneuronal_inds = ismember(subclasses,{'Endo','Astro','Oligo',...
            'Micro-PVM','SMC-Peri','VLMC'});
        gaba_inds = ismember(subclasses,{'Lamp5','Sncg','Meis2','CR',...
            'Pvalb','Sst','Sst Chodl','Vip'});
        ctxtest = @(x) strcmp(x(end),'X');
        glutctx_inds = logical(cell2mat(cellfun(ctxtest,subclasses,'UniformOutput',false)));
        gluthipp_inds = ~logical(nonneuronal_inds + gaba_inds + glutctx_inds);
        indcell = {glutctx_inds,gluthipp_inds,gaba_inds,nonneuronal_inds};
        indtest = glutctx_inds + 2*gluthipp_inds + 3*gaba_inds + 4*nonneuronal_inds;
        cmap_col = [[0 0.75 1]; [1 0 0.5]];
        cmap = twocolor(cmap_col(1,:),cmap_col(2,:),length(indcell));
        voxthreshes = [0.6,0.6]; % Brainframe parameter
        
        for i = 1:length(toptypeinds)
            ctdata = outstruct.corrB(:,toptypeinds(i));
            newVoxMap = zeros(size(GENGDmod));
            newVoxMap(nonzerovox) = ctdata;
            datinput = imresize3(newVoxMap,[133 81 115]);
            datinput(datinput < 0) = 0;
            col_base = cmap(indtest(toptypeinds(i)),:);
            col_min = (col_base + 1)/2;
            nbin = 10;
            cmap_i = twocolor(col_min,col_base,nbin);
            input_struct = brainframe_inputs_mouse(brainframedir,'data',datinput,...
                                                        'voxthresh',voxthreshes(i),...
                                                        'nbin',nbin,...
                                                        'voxUreg',0,...
                                                        'xfac',0.02,...
                                                        'pointsize',0.1,...
                                                        'bgcolor','w',...
                                                        'img_format','tiffn',...
                                                        'cmap',cmap_i,...
                                                        'regsUbins',0,...
                                                        'img_directory',figdirectory,...
                                                        'img_labels',['Yao_' subclasses{toptypeinds(i)}],...
                                                        'img_renderer','painters',...
                                                        'savenclose',savenclose);
            brainframe(input_struct);
        end
    else
        % % Finish later for Tasic/Zeisel   
    end
end

%% 2.3 End-timepoint pathology glassbrains
brainframedir = '/Users/justintorok/Documents/MATLAB/Brainframe-Dev/Brainframe';
addpath(brainframedir)
savenclose = 0;
reggroups_ = zeros(213,1); %Chunk of code to define region_groups
amy = 1:11; cer = 12:23; sub = 24:26; hip = 27:37; hyp = 38:57;
ncx = 58:95; med = 96:120; mid = 121:141; olf = 142:149; pal = 150:157;
pon = 158:170; str = 171:178; tha = 179:213;
reggroups_(amy) = 1; reggroups_(cer) = 2; reggroups_(sub) = 3; 
reggroups_(hip) = 4; reggroups_(hyp) = 5; reggroups_(ncx) = 6;
reggroups_(med) = 7; reggroups_(mid) = 8; reggroups_(olf) = 9;
reggroups_(pal) = 10; reggroups_(pon) = 11; reggroups_(str) = 12;
reggroups_(tha) = 13;
reggroups_ = [reggroups_;reggroups_];
cmap_ = hsv(length(unique(reggroups_)));
ngrad = 3;

for k = 1
    datset = 'IbaP301S';
    datinput_data = DataToCCF([],datset,matdir);
    datinput_k = datinput_data(:,1);
    nany = isnan(datinput_k);
    datinput_k(nany) = 0;
    if ~strcmp(datset,'Hurtado')
        xfac = 0.3*(max(datinput_k)/max(datinput_data(~nany,1)))^(1/3);
    else     
        xfac = 0.15*(max(datinput_k)/max(datinput_data(~nany,1)))^(1/3);
    end
    reggroups_data = zeros(length(reggroups_),1);
    cmap_data = zeros(length(unique(reggroups_))*ngrad,3);
    for i = 1:length(unique(reggroups_))
        cmap_i = cmap_(i,:);
        reggroup_i_inds = (reggroups_ == i);
        for j = 1:ngrad
            newgroupind = (i-1)*ngrad + j;
            thresh_j = j*100/ngrad;
            zeroinds = (reggroups_data == 0);
            threshinds = (datinput_k <= prctile(nonzeros(datinput_k),thresh_j));
            ij_inds = (zeroinds + threshinds + reggroup_i_inds == 3);
            reggroups_data(ij_inds) = newgroupind;
            cmap_data(newgroupind,:) = (1/2)*cmap_i + (1/2)*(((ngrad-j)*ones(1,3) + j*cmap_i)/ngrad);
        end
    end
    imglab = sprintf('PathologyBrainframe_Data_%s_t%s_%s',datset,'end',ctdataset);
    input_struct_data = brainframe_inputs_mouse(brainframedir,'data',datinput_k,...
                                                'voxUreg',1,...
                                                'xfac',xfac,...
                                                'pointsize',5,...
                                                'norm_method','max',...
                                                'bgcolor','w',...
                                                'img_format','tiffn',...
                                                'cmap',cmap_data,...
                                                'region_groups',reggroups_data,...
                                                'centered',[0 1],...
                                                'img_directory',figdirectory,...
                                                'img_labels',imglab,...
                                                'img_renderer','painters',...
                                                'savenclose',savenclose);
    brainframe(input_struct_data);
end


%% 3. Gene-based vulnerability
%% 3.1 Gene expression distance from top cell types
plotting = 1;
savenclose = 0;
genemat_allgenes = genevct_allgenes;
genemat_MRx3 = genevct(sort(geneinds(1:outstruct.nGen)),:);
ctmat = outstruct.Bmeans;
corrtype = 'Pearson';
genemattype = 'MRx3';
neuronly = 1;
usewls = 0;
usepos = 0;
seedcorr = 1;
t = 'end';
corrmat_t = CorrelationCalculator_singletimepoint(datsetnames,t,...
    mousedata_struct,ctmat,corrtype,seedcorr,matdir);
cmap = [[0 0.75 1]; [1 0 0.5]];

if plotting
    for i = 1:length(neuronly)
        for j = 1:length(usepos)
            [dist,tau,inds] = GeneExpressionDistance_vs_Tau_Plot(genemat_allgenes,genemat_MRx3,...
                genemattype,subclasses,neuronly(i),corrmat_t,corrtype,cmap,usewls,...
                usepos(j),savenclose,figdirectory);
        end
    end
end

%% 3.2 
% genemat_allgenes = genevct_allgenes;
genemat_MRx3 = genevct(sort(geneinds(1:outstruct.nGen)),:); 
genemat_MRx3(:,nonneuronal_inds) = [];
genemat_MRx3 = genemat_MRx3/max(genemat_MRx3(:));
ctmat = outstruct.Bmeans; 
ctmat(:,nonneuronal_inds) = [];
ctmat = ctmat / max(ctmat(:));
% indtest(nonneuronal_inds) = [];

% Rs = squareform(exp(-pdist(genemat_MRx3.','correlation')));
% idx = spectralcluster(Rs,3,'Distance','precomputed');
V = pca(genemat_MRx3);
figure; 
subplot(1,2,1); hold on;
for i = 1:length(unique(indtest))
    scatter(V(indtest==i,1),mean(corrmat_t(:,indtest == i)).',...
        'MarkerFaceColor',cmap(i,:),'MarkerEdgeColor',cmap(i,:));
end
xlabel('V_1, MRx3 genes')
ylabel('mean R with pathology')
set(gca,'FontSize',16)
% figure; gscatter(W(:,1),W(:,2),idx);
% 
% Rs = squareform(exp(-pdist(ctmat.','correlation')));
% idx = spectralcluster(Rs,4,'Distance','precomputed');
% V = pca(ctmat.');
% figure; gscatter(W(:,1),W(:,2));
V = pca(ctmat);
subplot(1,2,2); hold on;
for i = 1:length(unique(indtest))
    scatter(V(indtest==i,1),mean(corrmat_t(:,indtest == i)).',...
        'MarkerFaceColor',cmap(i,:),'MarkerEdgeColor',cmap(i,:));
end
xlabel('V_1, spatial')
ylabel('mean R with pathology')
set(gca,'FontSize',16)



%% 3.3 Vulnerability from common AD genes
corrtype = 'Pearson';
seedcorr = 1;
load([matdir filesep 'AD_Genes.mat'],'genelist');
t = 'end';
genelist_inds = zeros(1,length(genelist));
for i = 1:length(genelist_inds)
    genelist_inds(i) = find(ismember(gene_names,genelist{i}));
end
genemat_list = voxvgene(:,genelist_inds);
[~,genemat_list] = Voxel_To_Region(genemat_list,matdir);
corrmat_t_gene = CorrelationCalculator_singletimepoint(datsetnames,t,...
    mousedata_struct,genemat_list,corrtype,seedcorr,matdir);

plotting = 1;
savenclose = 1;
cmap = [[1 0 0]; [1 0.75 0]];
figtype = 'AD_Genes';
if plotting
    CorrelationBarPlot(corrmat_t_gene,datsetnames,genelist,corrtype,...
        cmap,figtype,savenclose,figdirectory);
end

%% 3.4 Gene expression glass brains
brainframedir = '/Users/justintorok/Documents/MATLAB/Brainframe-Dev/Brainframe';
addpath(brainframedir)
toptypes = genelist;
toptypeinds = find(ismember(genelist,toptypes));
% [x,toptypeinds] = max(abs(rhurt),[],2);
cmap = twocolor([1 0 0], [1 0.75 0],length(genelist));

plotting = 1;
savenclose = 1;
if plotting
    for i = 1:length(toptypeinds)
        ctdata = genemat_list(:,toptypeinds(i));
        newVoxMap = zeros(size(GENGDmod));
        newVoxMap(nonzerovox) = ctdata;
        datinput = imresize3(newVoxMap,[133 81 115]);
        datinput(datinput < 0) = 0;
        col_base = cmap(toptypeinds(i),:);
        col_min = (col_base + 1)/2;
        nbin = 10;
        cmap_i = twocolor(col_min,col_base,nbin);
        labstr = strrep(genelist{toptypeinds(i)},' ','_');
        labstr = strrep(labstr,'/','-');
        input_struct = brainframe_inputs_mouse(brainframedir,'data',datinput,...
                                                    'voxthresh',0.7,...
                                                    'nbin',nbin,...
                                                    'voxUreg',0,...
                                                    'xfac',0.02,...
                                                    'pointsize',0.1,...
                                                    'bgcolor','w',...
                                                    'img_format','tiffn',...
                                                    'cmap',cmap_i,...
                                                    'regsUbins',0,...
                                                    'img_directory',figdirectory,...
                                                    'img_labels',labstr,...
                                                    'img_renderer','painters',...
                                                    'savenclose',savenclose);
        brainframe(input_struct);
    end
end


%% 4. Internal structure of data
%% 4.1 Cross-correlation matrices with hierarchical clustering
plotting = 1;
savenclose = 1;
corrtype = 'MRx3';
clusttype = 'MRx3';
linktype = 'ward';
disttype = 'euclidean';
uselab = 1;
genemat_allgenes = genevct_allgenes;
genemat_MRx3 = genevct(sort(geneinds(1:outstruct.nGen)),:);
ctmat = outstruct.Bmeans;
cmap_label = [[0 0.75 1]; [1 0 0.5]];
cmap = [];

if plotting
    ClusteringHeatmap(genemat_allgenes,genemat_MRx3,ctmat,subclasses,...
        ctdataset,corrtype,clusttype,cmap,cmap_label,disttype,linktype,...
        uselab,savenclose,figdirectory);
end

%% 4.2 Cross-correlation matrices of data
plotting = 1;
savenclose = 1;
seedcorr = 1;
cmap = [[ones(500,1), 0.9*linspace(1,0.5,500).', 0.9*linspace(1,0,500).'];...
                    [ones(500,1), linspace(0.5,0,500).', 0*ones(500,1)]].^(1/2);

if plotting
    TauPathologyHeatmap(datsetnames,mousedata_struct,cmap,seedcorr,savenclose,figdirectory);
end

%% 5. Multivariate analyses
%% 5.1 Linear models and frequency bar plots, cell types
plotting = 1;
bicplotting = 1;
savenclose = 0;
usebic = 1;
numsigtypes = 5;
thresh = 75;
ctdataset = 'Yao';
corrtype = 'Pearson';
seedcorr = 1;
ctmat = outstruct.Bmeans;
t = 'end';
 
[mdls_bic,subclasses_bic,coeff_vals_bic,pvals_bic_vars] = ...
    LinearModelSelection_BIC_alldatasets(datsetnames,t,mousedata_struct,...
    ctmat,subclasses,corrtype,seedcorr,usebic,thresh,ctdataset,bicplotting,plotting,[],...
    savenclose,figdirectory,matdir);
[mdls_topN,subclasses_topN,coeff_vals_topN,pvals_bic_topN] = LinearModelSelection_TopN_alldatasets(datsetnames,t,...
    mousedata_struct,ctmat,subclasses,numsigtypes,corrtype,seedcorr,ctdataset,plotting,...
    [],savenclose,figdirectory,matdir);
CellTypeFrequencyPlot(subclasses,subclasses_bic,t,ctdataset,'BIC',[[0 0.75 1]; [1 0 0.5]],...
    savenclose,figdirectory);
CellTypeFrequencyPlot(subclasses,subclasses_topN,t,ctdataset,'TopN',[[0 0.75 1]; [1 0 0.5]],...
    savenclose,figdirectory);

%% 5.2 Linear models, AD genes
plotting = 1;
bicplotting = 1;
savenclose = 1;
ctdataset = 'Gene';
corrtype = 'Pearson';
seedcorr = 1;
usebic = 1;
thresh = 50;
load([matdir filesep 'AD_Genes.mat'],'genelist');
t = 'end';

genelist_inds = zeros(1,length(genelist));
for i = 1:length(genelist_inds)
    genelist_inds(i) = find(ismember(gene_names,genelist{i}));
end
genemat_list = voxvgene(:,genelist_inds);
[~,genemat_list] = Voxel_To_Region(genemat_list,matdir);

% [mdls_all_gene,subclasses_all_gene] = LinearModelSelection_BIC_alldatasets(datsetnames,t,...
%     mousedata_struct,genemat_list,genelist,length(genelist),corrtype,seedcorr,ctdataset,plotting,...
%     [],savenclose,figdirectory,matdir);
[mdls_bic_gene,subclasses_bic_gene,coeff_vals_gene,pvals_bic_gene] = ...
    LinearModelSelection_BIC_alldatasets(datsetnames,t,mousedata_struct,...
    genemat_list,subclasses,corrtype,seedcorr,usebic,thresh,ctdataset,bicplotting,plotting,[],...
    savenclose,figdirectory,matdir); 

%% 6.1 Hurtado per-timepoint
plotting = 1;
bicplotting = 1;
savenclose = 1;
usebic = 1;
ctdataset = 'Yao';
corrtype = 'Pearson';
seedcorr = 1;
datset = 'Hurtado';
ctmat = outstruct.Bmeans;
cmap = twocolor([0,1,0.25],[0.5,0,1],length(mousedata_struct.(datset).time_stamps));

[mdls_bic_hurtado,subclasses_bic_hurtado,xcti,Y,rhurt] = LinearModelSelection_BIC_alltpts(...
    datset,mousedata_struct,ctmat,subclasses,corrtype,seedcorr,usebic,ctdataset,...
    bicplotting,plotting,cmap,savenclose,figdirectory,matdir);

%% 6.2 Hurtado pathology glass-brains, space-filling
brainframedir = '/Users/justintorok/Documents/MATLAB/Brainframe-Dev/Brainframe';
addpath(brainframedir)
datset = 'Hurtado';
tpts = mousedata_struct.(datset).time_stamps;
savenclose = 1;
reggroups_ = zeros(213,1); %Chunk of code to define region_groups
amy = 1:11; cer = 12:23; sub = 24:26; hip = 27:37; hyp = 38:57;
ncx = 58:95; med = 96:120; mid = 121:141; olf = 142:149; pal = 150:157;
pon = 158:170; str = 171:178; tha = 179:213;
reggroups_(amy) = 1; reggroups_(cer) = 2; reggroups_(sub) = 3; 
reggroups_(hip) = 4; reggroups_(hyp) = 5; reggroups_(ncx) = 6;
reggroups_(med) = 7; reggroups_(mid) = 8; reggroups_(olf) = 9;
reggroups_(pal) = 10; reggroups_(pon) = 11; reggroups_(str) = 12;
reggroups_(tha) = 13;
% fore = [amy,sub,hip,olf,pal,str];
% dimes = [hyp,mid,tha];
% hind = [cer,med,pon];
% 
% reggroups_(ncx) = 1;
% reggroups_(fore) = 2;
% reggroups_(dimes) = 3;
% reggroups_(hind) = 4;
reggroups_ = [reggroups_;reggroups_];
% cmap_ = [[1 0 0]; [0 0 1]; [1 0 1]; [1 0.5 0]];
cmap_ = hsv(length(unique(reggroups_)));
ngrad = 3;

datinput_data = DataToCCF([],datset,matdir);
datinput_pred = zeros(size(datinput_data));
for i = 1:size(datinput_pred,2)
    mdlpred = mdls_bic_hurtado{i}.Fitted;
    mdlpred(mdlpred < 0) = 0;
    datinput_pred(:,i) = DataToCCF(mdlpred,datset,matdir);
end

for k = 1:size(datinput_data,2)
    datinput_k = datinput_data(:,k);
    nany = isnan(datinput_k);
    datinput_k(nany) = 0;
    xfac = 0.15*(max(datinput_k)/max(datinput_data(~nany,1)))^(1/3);
    reggroups_data = zeros(length(reggroups_),1);
    cmap_data = zeros(length(unique(reggroups_))*ngrad,3);
    for i = 1:length(unique(reggroups_))
        cmap_i = cmap_(i,:);
        reggroup_i_inds = (reggroups_ == i);
        for j = 1:ngrad
            newgroupind = (i-1)*ngrad + j;
            thresh_j = j*100/ngrad;
            zeroinds = (reggroups_data == 0);
            threshinds = (datinput_k <= prctile(nonzeros(datinput_k),thresh_j));
            ij_inds = (zeroinds + threshinds + reggroup_i_inds == 3);
            reggroups_data(ij_inds) = newgroupind;
%             cmap_data(newgroupind,:) = cmap_i;
%             cmap_data(newgroupind,:) = ((ngrad-j)*ones(1,3) + j*cmap_i)/(ngrad);
            cmap_data(newgroupind,:) = (1/2)*cmap_i + (1/2)*(((ngrad-j)*ones(1,3) + j*cmap_i)/ngrad);
        end
    end
    imglab = sprintf('PathologyBrainframe_Data_%s_t%d_%s',datset,tpts(k),ctdataset);
    input_struct_data = brainframe_inputs_mouse(brainframedir,'data',datinput_k,...
                                                'voxUreg',1,...
                                                'xfac',xfac,...
                                                'pointsize',5,...
                                                'norm_method','max',...
                                                'bgcolor','w',...
                                                'img_format','tiffn',...
                                                'cmap',cmap_data,...
                                                'region_groups',reggroups_data,...
                                                'centered',[0 1],...
                                                'img_directory',figdirectory,...
                                                'img_labels',imglab,...
                                                'img_renderer','painters',...
                                                'savenclose',savenclose);
    brainframe(input_struct_data);

    datinput_k = datinput_pred(:,k);
    nany = isnan(datinput_k);
    datinput_k(nany) = 0;
    xfac = 0.15*(max(datinput_k)/max(datinput_pred(~nany,1)))^(1/3);
    reggroups_pred = zeros(length(reggroups_),1);
    cmap_pred = zeros(length(unique(reggroups_))*ngrad,3);
    for i = 1:length(unique(reggroups_))
        cmap_i = cmap_(i,:);
        reggroup_i_inds = (reggroups_ == i);
        for j = 1:ngrad
            newgroupind = (i-1)*ngrad + j;
            thresh_j = j*100/ngrad;
            zeroinds = (reggroups_pred == 0);
            threshinds = (datinput_k <= prctile(nonzeros(datinput_k),thresh_j));
            ij_inds = (zeroinds + threshinds + reggroup_i_inds == 3);
            reggroups_pred(ij_inds) = newgroupind;
%             cmap_data(newgroupind,:) = cmap_i;
%             cmap_data(newgroupind,:) = ((ngrad-j)*ones(1,3) + j*cmap_i)/(ngrad);
            cmap_pred(newgroupind,:) = (1/2)*cmap_i + (1/2)*(((ngrad-j)*ones(1,3) + j*cmap_i)/ngrad);
        end
    end
    imglab = sprintf('PathologyBrainframe_Predicted_%s_t%d_%s',datset,tpts(k),ctdataset);
    input_struct_pred = brainframe_inputs_mouse(brainframedir,'data',datinput_k,...
                                                'voxUreg',1,...
                                                'xfac',xfac,...
                                                'pointsize',15,...
                                                'norm_method','max',...
                                                'bgcolor','w',...
                                                'img_format','tiffn',...
                                                'cmap',cmap_pred,...
                                                'region_groups',reggroups_pred,...
                                                'centered',[0 1],...
                                                'regsUbins',0,...
                                                'img_directory',figdirectory,...
                                                'img_labels',imglab,...
                                                'img_renderer','painters',...
                                                'savenclose',savenclose);
    brainframe(input_struct_pred);
end

%% 6.3 Top Hurtado cell types, glass brains
brainframedir = '/Users/justintorok/Documents/MATLAB/Brainframe-Dev/Brainframe';
addpath(brainframedir)
toptypes = {'L3 IT ENT','Sst','CT SUB','Oligo'}; % Highest t-stat in linear models
% toptypes = {'L2 IT ENTl', 'L2 IT ENTm', 'L2/3 IT ENTl'};
toptypeinds = find(ismember(subclasses,toptypes));
% [x,toptypeinds] = max(abs(rhurt),[],2);
% toptypes = subclasses(toptypeinds); % Highest correlation to pathology

plotting = 1;
savenclose = 0;
if length(subclasses) == 42
    if plotting
        nonneuronal_inds = ismember(subclasses,{'Endo','Astro','Oligo',...
            'Micro-PVM','SMC-Peri','VLMC'});
        gaba_inds = ismember(subclasses,{'Lamp5','Sncg','Meis2','CR',...
            'Pvalb','Sst','Sst Chodl','Vip'});
        glutctx_other_inds = ismember(subclasses,{'Car3','L4 RSP-ACA'});
        ctxtest = @(x) strcmp(x(end),'X');
        glutctx_inds = logical(cell2mat(cellfun(ctxtest,subclasses,'UniformOutput',false)));
        glutctx_inds = glutctx_inds + glutctx_other_inds;
        gluthipp_inds = ~logical(nonneuronal_inds + gaba_inds + glutctx_inds);
        indcell = {glutctx_inds,gluthipp_inds,gaba_inds,nonneuronal_inds};
        indtest = glutctx_inds + 2*gluthipp_inds + 3*gaba_inds + 4*nonneuronal_inds;
        cmap_col = [[0 0.75 1]; [1 0 0.5]];
        cmap = twocolor(cmap_col(1,:),cmap_col(2,:),length(indcell));
        voxthreshes = [0.6,0.6,0.6,0.6];
        
        for i = 1:length(toptypeinds)
            ctdata = outstruct.corrB(:,toptypeinds(i));
            newVoxMap = zeros(size(GENGDmod));
            newVoxMap(nonzerovox) = ctdata;
            datinput = imresize3(newVoxMap,[133 81 115]);
            datinput(datinput < 0) = 0;
            col_base = cmap(indtest(toptypeinds(i)),:);
            col_min = (col_base + 1)/2;
            nbin = 10;
            cmap_i = twocolor(col_min,col_base,nbin);
            labstr = ['Yao_' strrep(subclasses{toptypeinds(i)},' ','_')];
            labstr = strrep(labstr,'/','-');
            input_struct = brainframe_inputs_mouse(brainframedir,'data',datinput,...
                                                        'voxthresh',voxthreshes(i),...
                                                        'nbin',nbin,...
                                                        'voxUreg',0,...
                                                        'xfac',0.02,...
                                                        'pointsize',0.1,...
                                                        'bgcolor','w',...
                                                        'img_format','tiffn',...
                                                        'cmap',cmap_i,...
                                                        'regsUbins',0,...
                                                        'img_directory',figdirectory,...
                                                        'img_labels',labstr,...
                                                        'img_renderer','painters',...
                                                        'savenclose',savenclose);
            brainframe(input_struct);
        end
    end
else
    % % Finish later for Tasic/Zeisel     
    %     nonneuronal_inds = ismember(subclasses,{'Endo','Astro','Oligo',...
    %         'Macro'});
    %     gaba_inds = ismember(subclasses,{'Lamp5','Sncg','Meis2','CR',...
    %         'Pvalb','Sst','Serpinf1','Vip'});
    %     ctxtest = @(x) strcmp(x(end),'X');
    %     glutctx_inds = logical(cell2mat(cellfun(ctxtest,subclasses,'UniformOutput',false)));
    %     gluthipp_inds = ~logical(nonneuronal_inds + gaba_inds + glutctx_inds);
    %     indcell = {glutctx_inds,gluthipp_inds,gaba_inds,nonneuronal_inds};
    %     indtest = glutctx_inds + 2*gluthipp_inds + 3*gaba_inds + 4*nonneuronal_inds;
end

%% 7. Miscellaneous figures
%% 7.1 Plots for schematic
% tSNE
savenclose = 0;
usetSNE = 1;
genelist_schem = sort({'Sst','Pvalb','Rorb','Aqp4','Mapt','App','Apoe'});
ClusteringSchematic(usetSNE,savenclose,figdirectory);
GeneExpressionSchematic(genelist_schem,34,savenclose,datapath,figdirectory);