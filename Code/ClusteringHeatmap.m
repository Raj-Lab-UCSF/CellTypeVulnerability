function ClusteringHeatmap(genematall_,genematmrx3_,ctmat_,subclasses_,datasource,...
    corrtype_,clusttype_,cmap_,cmap_label_,disttype_,linktype_,savenclose,figdir_)
if nargin < 13
    figdir_ = cd;
    if nargin < 12
        savenclose = 0;
        if nargin < 11
            linktype_ = 'ward';
            if nargin < 10
                disttype_ = 'euclidean';
                if nargin < 9
                    cmap_label_ = [];
                    if nargin < 8
                        cmap_ = [];
                    end
                end
            end
        end
    end
end

switch clusttype_
    case 'Spatial'
        clustdata = ctmat_;
        dists = pdist(clustdata.',disttype_);
        links = linkage(dists,linktype_);
        reorder_inds = optimalleaforder(links,dists);
        subclasses_reorder = subclasses_(reorder_inds);
    case 'AllGenes'
        clustdata = genematall_;
        dists = pdist(clustdata.',disttype_);
        links = linkage(dists,linktype_);
        reorder_inds = optimalleaforder(links,dists);
        subclasses_reorder = subclasses_(reorder_inds);   
    case 'MRx3'
        clustdata = genematmrx3_;
        dists = pdist(clustdata.',disttype_);
        links = linkage(dists,linktype_);
        reorder_inds = optimalleaforder(links,dists);
        subclasses_reorder = subclasses_(reorder_inds);  
end

switch corrtype_
    case 'Spatial'
        corrdata = ctmat_;
        corrlims = [-0.6,0.6];
        if isequal(cmap_,[])
            cmap_ = redblue(1000);
        else
            cmap_ = twocolor(cmap_(1,:),cmap_(2,:),1000);
        end
    case 'AllGenes'
        corrdata = genematall_;
        corrlims = [0.3,1];
        if isequal(cmap_,[])
%             cmap_ = hot(1000);
            cmap_ = [[ones(500,1), 0.9*linspace(1,0.5,500).', 0.9*linspace(1,0,500).'];...
                    [ones(500,1), linspace(0.5,0,500).', 0*ones(500,1)]].^(2/3);
        else
            cmap_ = twocolor(cmap_(1,:),cmap_(2,:),1000);
        end

    case 'MRx3'
        corrdata = genematmrx3_;
        corrlims = [0,1];
        if isequal(cmap_,[])
%             cmap_ = hot(1000);
            cmap_ = [[ones(500,1), linspace(1,0.5,500).', linspace(1,0,500).'];...
                    [ones(500,1), linspace(0.5,0,500).', 0*ones(500,1)]].^(2/3);
        else
            cmap_ = twocolor(cmap_(1,:),cmap_(2,:),1000);
        end
end
corrs = corrcoef(corrdata);

if strcmp(datasource,'Tasic')
% % Finish later       
%     nonneuronal_inds = ismember(subclasses,{'Endo','Astro','Oligo',...
%         'Macro'});
%     gaba_inds = ismember(subclasses,{'Lamp5','Sncg','Meis2','CR',...
%         'Pvalb','Sst','Serpinf1','Vip'});
%     ctxtest = @(x) strcmp(x(end),'X');
%     glutctx_inds = logical(cell2mat(cellfun(ctxtest,subclasses,'UniformOutput',false)));
%     gluthipp_inds = ~logical(nonneuronal_inds + gaba_inds + glutctx_inds);
%     indcell = {glutctx_inds,gluthipp_inds,gaba_inds,nonneuronal_inds};
%     indtest = glutctx_inds + 2*gluthipp_inds + 3*gaba_inds + 4*nonneuronal_inds;
elseif strcmp(datasource,'Yao')
    nonneuronal_inds = ismember(subclasses_,{'Endo','Astro','Oligo',...
        'Micro-PVM','SMC-Peri','VLMC'});
    gaba_inds = ismember(subclasses_,{'Lamp5','Sncg','Meis2','CR',...
        'Pvalb','Sst','Sst Chodl','Vip'});
    ctxtest = @(x) strcmp(x(end),'X');
    glutctx_inds = logical(cell2mat(cellfun(ctxtest,subclasses_,'UniformOutput',false)));
    gluthipp_inds = ~logical(nonneuronal_inds + gaba_inds + glutctx_inds);
    indcell = {glutctx_inds,gluthipp_inds,gaba_inds,nonneuronal_inds};
    indtest = glutctx_inds + 2*gluthipp_inds + 3*gaba_inds + 4*nonneuronal_inds;
end

if isequal(cmap_label_,[])
    cmap_cts = zeros(indtest,3);
else
    cmap_lab_base = twocolor(cmap_label_(1,:),cmap_label_(2,:),length(indcell));
    cmap_cts = zeros(length(indtest),3);
    for i = 1:length(indtest)
        cmap_cts(i,:) = cmap_lab_base(indtest(i),:);
    end
    cmap_cts = cmap_cts(reorder_inds,:);
end


figure('Units','inches','Position',[0 0 10 2])
D = dendrogram(links,length(subclasses_reorder),'Reorder',reorder_inds);
for i = 1:length(D)
    D(i).Color = [0 0 0];
end
set(D,'LineWidth',1.5);
set(gca,'visible','off');
if savenclose
    print([figdir_ filesep sprintf('Dendrogram_%s_%s',clusttype_,datasource)],'-dtiffn','-r600'); close;
end


% Correlation heatmap
figure('Units','inches','Position',[0 0 20 15])
imagesc(corrs(reorder_inds,reorder_inds),corrlims); colormap(cmap_);
labs = cell(1,length(subclasses_));
for i = 1:length(subclasses_)
    col = cmap_cts(i,:);
    labs{i} = sprintf('\\color[rgb]{%f,%f,%f}%s',col(1),col(2),col(3),subclasses_reorder{i});
end
set(gca,'XTick',1:length(subclasses_),'XTickLabel',labs,'TickLabelInterpreter','tex',...
     'XTickLabelRotation',90);
set(gca,'TickLength',[0 0],'DataAspectRatio',[1 1 1],'XTick',1:length(subclasses_reorder),...
    'XTickLabelRotation',90,'XTickLabel',labs,...
    'YTickLabel',{''},'FontName','Times','FontSize',17)
for i = 1:length(subclasses_reorder)
    text(length(subclasses_reorder)+0.75,i,labs{i},'FontSize',17,'FontName','Times')
end
cb = colorbar; a = get(cb); a = a.Position;
set(cb,'Position',[a(1)+0.06,a(2),2*a(3),a(4)]);
if savenclose
    print([figdir_ filesep sprintf('CrossCorr_%sCorrs_%sClust_%s',corrtype_,...
        linktype_,datasource)],'-dtiffn','-r600'); close;
end

% % Heatmap, spatial correlation, all-gene clustering 
% figure('Units','inches','Position',[0 0 20 15])
% I = imagesc(ct_corrs_s(reorder_inds,reorder_inds),[-0.6,0.6]); colormap redblue;
% set(gca,'TickLength',[0 0],'DataAspectRatio',[1 1 1],'XTick',1:length(classkey),...
%     'XTickLabelRotation',90,'XTickLabel',subclasses_crosscorr_g,...
%     'YTickLabel',{''},'FontName','Times','FontSize',17)
% for i = 1:length(subclasses_crosscorr_g)
%     text(length(classkey)+0.75,i,subclasses_crosscorr_g{i},'FontSize',17,'FontName','Times')
% end
% cb = colorbar; a = get(cb); a = a.Position;
% set(cb,'Position',[a(1)+0.06,a(2),2*a(3),a(4)]);
% %     set(cb,'Position',[a(1)+0.115,a(2),2*a(3),a(4)]);
% if savenclose
%     print([figdir_ filesep 'CrossCorr_SpatialCorrs_AllGeneClust_' ctdataset],'-dtiffn','-r600'); close;
% end
% 
% % Heatmap, spatial correlation, MRx3 clustering 
% figure('Units','inches','Position',[0 0 20 15])
% I = imagesc(ct_corrs_s(ct_reorder_mrx3,ct_reorder_mrx3),[-0.6,0.6]); colormap redblue;
% set(gca,'TickLength',[0 0],'DataAspectRatio',[1 1 1],'XTick',1:length(classkey),...
%     'XTickLabelRotation',90,'XTickLabel',subclasses_crosscorr_mrx3,...
%     'YTickLabel',{''},'FontName','Times','FontSize',17)
% for i = 1:length(subclasses_crosscorr_mrx3)
%     text(length(classkey)+0.75,i,subclasses_crosscorr_mrx3{i},'FontSize',17,'FontName','Times')
% end
% cb = colorbar; a = get(cb); a = a.Position;
% set(cb,'Position',[a(1)+0.06,a(2),2*a(3),a(4)]);
% %     set(cb,'Position',[a(1)+0.115,a(2),2*a(3),a(4)]);
% if savenclose
%     print([figdir_ filesep 'CrossCorr_SpatialCorrs_MRx3Clust_' ctdataset],'-dtiffn','-r600'); close;
% end
% 
% % Heatmap, all-gene correlation, all-gene clustering
% cmap_corrs_g = [[ones(500,1), 0.9*linspace(1,0.5,500).', 0.9*linspace(1,0,500).'];...
%     [ones(500,1), linspace(0.5,0,500).', 0*ones(500,1)]].^(2/3);
% corrlim = 0.3;
% figure('Units','inches','Position',[0 0 20 15])
% I = imagesc(ct_corrs_g(reorder_inds,reorder_inds),[corrlim,1]); colormap(cmap_corrs_g);
% set(gca,'TickLength',[0 0],'DataAspectRatio',[1 1 1],'XTick',1:length(classkey),...
%     'XTickLabelRotation',90,'XTickLabel',subclasses_crosscorr_g,...
%     'YTickLabel',{''},'FontName','Times','FontSize',17)
% for i = 1:length(subclasses_crosscorr_g)
%     text(length(classkey)+0.75,i,subclasses_crosscorr_g{i},'FontSize',17,'FontName','Times')
% end
% cb = colorbar; a = get(cb); a = a.Position;
% cbnumticks = int8(1 + (1-corrlim)/0.1);
% cbticks = linspace(corrlim,1,cbnumticks);
% cbticklabels = cell(1,cbnumticks);
% for j = 1:cbnumticks
%     if j == 1 && corrlim ~= 0 
%         if mod(100*cbticks(j),10) == 0
%             cbticklabels{j} = sprintf('< %.1f',cbticks(j));
%         else
%             cbticklabels{j} = sprintf('< %.2f',cbticks(j));
%         end
%     else
%         cbticklabels{j} = num2str(cbticks(j),2);
%     end
% end
% %     set(cb,'Position',[a(1)+0.115,a(2),2*a(3),a(4)],'Ticks',cbticks,'TickLabels',...
% %         cbticklabels);
% set(cb,'Position',[a(1)+0.06,a(2),2*a(3),a(4)],'Ticks',cbticks,'TickLabels',...
%     cbticklabels);
% if savenclose
%     print([figdir_ filesep 'CrossCorr_AllGeneCorrs_AllGeneClust_' ctdataset],'-dtiffn','-r600'); close;
% end
% 
% % Heatmap, MRx3 correlation, MRx3 clustering
% figure('Units','inches','Position',[0 0 20 15])
% I = imagesc(ct_corrs_mrx3(ct_reorder_mrx3,ct_reorder_mrx3),[0,1]); colormap(cmap_corrs_g);
% set(gca,'TickLength',[0 0],'DataAspectRatio',[1 1 1],'XTick',1:length(classkey),...
%     'XTickLabelRotation',90,'XTickLabel',subclasses_crosscorr_mrx3,...
%     'YTickLabel',{''},'FontName','Times','FontSize',17)
% for i = 1:length(subclasses_crosscorr_mrx3)
%     text(length(classkey)+0.75,i,subclasses_crosscorr_mrx3{i},'FontSize',17,'FontName','Times')
% end
% cb = colorbar; a = get(cb); a = a.Position;
% set(cb,'Position',[a(1)+0.06,a(2),2*a(3),a(4)]);
% %     set(cb,'Position',[a(1)+0.115,a(2),2*a(3),a(4)]);
% if savenclose
%     print([figdir_ filesep 'CrossCorr_MRx3Corrs_MRx3Clust_' ctdataset],'-dtiffn','-r600'); close;
% end
% 
% % Heatmap, MRx3 correlation, spatial clustering
% figure('Units','inches','Position',[0 0 20 15])
% I = imagesc(ct_corrs_mrx3(ct_reorder_s,ct_reorder_s),[0,1]); colormap(cmap_corrs_g);
% set(gca,'TickLength',[0 0],'DataAspectRatio',[1 1 1],'XTick',1:length(classkey),...
%     'XTickLabelRotation',90,'XTickLabel',subclasses_crosscorr_s,...
%     'YTickLabel',{''},'FontName','Times','FontSize',17)
% for i = 1:length(subclasses_crosscorr_s)
%     text(length(classkey)+0.75,i,subclasses_crosscorr_s{i},'FontSize',17,'FontName','Times')
% end
% cb = colorbar; a = get(cb); a = a.Position;
% set(cb,'Position',[a(1)+0.06,a(2),2*a(3),a(4)]);
% %     set(cb,'Position',[a(1)+0.115,a(2),2*a(3),a(4)]);
% if savenclose
%     print([figdir_ filesep 'CrossCorr_MRx3Corrs_SpatialClust_' ctdataset],'-dtiffn','-r600'); close;
% end
end