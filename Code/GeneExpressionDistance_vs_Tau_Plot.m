function [corrgene_mat,corrtau_sort,sort_inds] = GeneExpressionDistance_vs_Tau_Plot(genematall_,...
    genematmrx3_,celltypemat_, mattype_,subclasses_,neurononly_,corrmat_,corrtype_,cmap_,usewls_,...
    poscell,savenclose,figdir_)

switch mattype_
    case 'AllGenes'
        genemat = genematall_;
        figstr = 'GeneExpressionDistance_AllGenes_';
    case 'MRx3'
        genemat = genematmrx3_;
        figstr = 'GeneExpressionDistance_MRx3_';
    case 'Spatial'
        genemat = celltypemat_;
        figstr = 'SpatialDistance_';
end

if length(subclasses_) == 25
    % Will finish for Tasic at a later time
    figstr = [figstr 'Tasic_'];
elseif length(subclasses_) == 42
    figstr = [figstr 'Yao_'];
    nonneuronal_inds = find(ismember(subclasses_,{'Endo','Astro','Oligo',...
        'Micro-PVM','SMC-Peri','VLMC'}));
    gaba_inds = find(ismember(subclasses_,{'Lamp5','Sncg','Meis2','CR',...
        'Pvalb','Sst','Sst Chodl','Vip'}));
    glutctx_other_inds = find(ismember(subclasses_,{'Car3','L4 RSP-ACA'}));
    ctxtest = @(x) strcmp(x(end),'X');
    glutctx_inds = find(logical(cell2mat(cellfun(ctxtest,subclasses_,'UniformOutput',false))));
    glutctx_inds = sort([glutctx_other_inds; glutctx_inds]);
    gluthipp_inds = setdiff((1:length(subclasses_)).',[nonneuronal_inds;gaba_inds;glutctx_inds]);
    indcell = {glutctx_inds,gluthipp_inds,gaba_inds,nonneuronal_inds};
    if strcmp(cmap_,'cool')
        cmap_labs = cool(length(indcell));
    elseif strcmp(cmap_,'hsv')
        cmap_labs = hsv(length(indcell));
    elseif strcmp(cmap_,'lines')
        cmap_labs = lines(length(indcell));
    else
        cmap_labs = twocolor(cmap_(1,:),cmap_(2,:),length(indcell));
    end
else
    if strcmp(cmap_,'cool')
        cmap_labs = cool(length(subclasses_));
    elseif strcmp(cmap_,'hsv')
        cmap_labs = hsv(length(subclasses_));
    elseif strcmp(cmap_,'lines')
        cmap_labs = lines(length(subclasses_));
    else
        cmap_labs = twocolor(cmap_(1,:),cmap_(2,:),length(subclasses_));
    end
    indcell = cell(1,length(subclasses_));
    for i = 1:length(indcell)   
        indcell{i} = i;
    end
end

groupids = zeros(length(subclasses_),1);
for i = 1:length(groupids)
    id_i = zeros(1,length(indcell));
    for j = 1:length(indcell)
        id_i(j) = ismember(i,indcell{j});
    end
    groupids(i) = find(id_i);
end
if usewls_
    figstr = [figstr 'WLS'];
else
    figstr = [figstr 'OLS'];
end
if neurononly_
    figstr = [figstr 'NeuronalOnly_'];
    corrmat_(:,nonneuronal_inds) = [];
    subclasses_(nonneuronal_inds) = [];
    groupids(nonneuronal_inds) = [];
    cmap_labs(end,:) = [];
    genemat(:,nonneuronal_inds) = [];
end
corrtau = mean(corrmat_);
if poscell
    [corrtau_sort,sort_inds] = sort(corrtau,'descend');
else
    [corrtau_sort,sort_inds] = sort(-corrtau,'descend');
end
corrtau_sort(1) = []; 
corrtau_std = std(corrmat_);
corrtau_std_sort = corrtau_std(sort_inds);
corrtau_std_sort(1) = [];
if usewls_
    weights_sort = (corrtau_std_sort.^(-1)).';
else
    weights_sort = ones(length(corrtau_std_sort),1);
end
subclasses_sort = subclasses_(sort_inds);
groupids_sort = groupids(sort_inds);
groupids_sort(1) = [];
reftype = subclasses_sort(1);
genemat_sort = genemat(:,sort_inds);
corrgene_mat = squareform(pdist(genemat_sort.','correlation'));
distance_reftype = corrgene_mat(1,:);
distance_reftype(1) = [];
% corrgene_mat = corr(genemat_sort);
% distance_reftype = 1 - corrgene_mat(1,:);
lm = fitlm(distance_reftype.',corrtau_sort.','Weights',weights_sort);  
x_lm = linspace(min(distance_reftype),max(distance_reftype),100).'; 
[y_lm, y_ci] = predict(lm, x_lm);

figure('Units','inches','Position',[0 0 9 9]); hold on;
errorbar(distance_reftype.',corrtau_sort.',corrtau_std_sort,'LineStyle','none','Color',[0 0 0],'MarkerSize',0.1);
plot(x_lm,y_ci(:,1),'k:'); plot(x_lm,y_ci(:,2),'k:'); 
fill([x_lm; flipud(x_lm)],[y_ci(:,1); flipud(y_ci(:,2))],[1 0 0.25],'EdgeColor','none','FaceAlpha',0.15);
g = gscatter(distance_reftype.',corrtau_sort.',groupids_sort,cmap_labs,'o',10,'off');
for i = 1:length(g)
    set(g(i),'MarkerFaceColor',cmap_labs(i,:));
end
h = plot(x_lm,y_lm,'k','LineWidth',2);
plot(x_lm,zeros(1,length(x_lm)),'Color',[0.25 0.25 0.25],'LineStyle','--');
if neurononly_
    leg = legend([g; h],{'Cort. Glut.',...
            'Hipp. Glut.',...
            'GABAergic',...
            sprintf(['R^2 = %.2f,' newline 'p = %.1d'],...
            lm.Rsquared.Adjusted,lm.ModelFitVsNullModel.Pvalue)},...
            'Location','none','box','off');
    set(leg,'units','normalized','position',[0.64,0.72,0.3,0.2],'color','none');
    xmax = max(distance_reftype); xmin = min(distance_reftype);
    xlim([xmin,xmax]); xticks([xmin,(xmax+xmin)/2,xmax]);
    xticklabels({num2str(xmin,'%.2f'),num2str((xmin+xmax)/2,'%.2f'),num2str(xmax,'%.2f')});
else
    leg = legend([g; h],{'Cort. Glut.',...
            'Hipp. Glut.',...
            'GABAergic',...
            'Non-Neuronal',...
            sprintf(['R^2 = %.2f,' newline 'p = %.1d'],...
            lm.Rsquared.Adjusted,lm.ModelFitVsNullModel.Pvalue)},...
            'Location','none','box','off');
    set(leg,'units','normalized','position',[0.6,0.7,0.3,0.2],'color','none');
    xmax = max(distance_reftype); xmin = min(distance_reftype);
    xlim([xmin,xmax]); xticks([xmin,(xmax+xmin)/2,xmax]);
    xticklabels({num2str(xmin,'%.2f'),num2str((xmin+xmax)/2,'%.2f'),num2str(xmax,'%.2f')});
end
% if usewls_
ymin = min(corrtau - corrtau_std); ymax = max(corrtau + corrtau_std);
ytickmin = min(corrtau); ytickmax = max(corrtau);
% else
%     ymin = min(corrtau); ymax = max(corrtau);
%     ytickmin = ymin; ytickmax = ymax;
% end
ylim(1.05*[ymin,ymax]);
yticks([ytickmin,0,ytickmax]);
yticklabels({num2str(ytickmin,'%.2f'),'0',num2str(ytickmax,'%.2f')});
if ~strcmp(mattype_,'Spatial')
    xlabel(['Gene Expression Distance from ' reftype]);
else
    xlabel(['Spatial Correlation Distance from ' reftype]);
end
if strcmp(corrtype_,'Pearson')
    ylabel("Mean Pearson's R, Tau Pathology");
elseif strcmp(corrtype_,'Partial')
    ylabel("Mean Partial Correlation \rho, Tau Pathology");
end
set(gca,'FontName','Times','FontSize',26,'box','on');
set(leg,'fontsize',20);

if savenclose
    print([figdir_ filesep figstr],'-dtiffn','-r600'); close;
end

end